## OpenPose Evaluation on DHP19
Evaluation of OpenPose on DHP19 can be done using the following steps


### 1. Create Grayscale Frames
- Follow instructions in file `/hpe-core/evaluation/dhp19/e2vid/README.MD` to create grayscale frames from preprocessed
DHP19 events.


### 2. Extract 2D Ground-Truth Poses
- After downloading the `.mat` files for the events and the Vicon data, run
  ```shell
  $ cd hpe-core/evaluation/dhp19
  $ python export_gt_poses.py
              -e /path/to/events/files/S%d_%d_%d.mat
              -v /path/to/vicon/files/S%d_%d_%d.mat
              -c <cam_id>
              -p /path/to/P_matrices/P%d.npy
              -o /path/to/output_folder
              -td
  ```

  where
  * `-e` and `-v` specify the paths to the files containing the preprocessed events and vicon data, respectively
  * `-c` is the id of the camera (in range [0, 3])
  * `-p` is the path to the projection matrix file used to project 3D poses to 2D (cam_id_0->P4.npy, cam_id_1->P1.npy, cam_id_2->P3.npy, cam_id_3->P2.npy)
  * `-o` is the path to the output folder.


### 3. Predict 2D Poses with OpenPose
- Download the Dockerfile from the [EDPR-APRIL OpenPose repository](https://github.com/event-driven-robotics/EDPR-APRIL/tree/openpose-yarp-docker)
and build the Docker image
  ```shell
  $ cd /path/to/dockerfile
  $ docker build -t op-yarp - < Dockerfile
  ```
- Run the Docker container and, inside it, run the pose detector
  ```shell
  $ xhost +
  $ docker run -it -v /tmp/.X11-unix/:/tmp/.X11-unix -v /path/to/grayscale/frames:/data -e DISPLAY=unix$DISPLAY --runtime=nvidia <image_id>
  $ ./pose_detector_json
              -input_folder /path/to/grayscale/frames
              -output_folder /path/to/output/folder
              --write_json /path/to/output/folder
              --model-folder /openpose/models
  ```
OpenPose will create in `/path/to/output/folder` one `.json` file for each input frame.


### 4. Evaluate OpenPose
Once all previous steps have been completed, there should be
- one folder with `n` grayscale frames generated by E2Vid
- one folder with `n` `.json` pose files created by OpenPose
- one file `.npy` file containing `n` ground-truth poses extracted from DHP19
with `n` varying according to the length of the DHP19 recording (see [DHP19's website](https://sites.google.com/view/dhp19/home)).

Run
```shell
$ cd hpe-core/evaluation
$ python evaluate_openpose.py
            -gt /path/to/recording/gt/poses.npy
            -p /path/to/json/files
            -if /path/to/grayscale/frames
            -o /path/to/output/folder
```
where
* `-gt` is the path to the .npy
* `-p` is the path to the json files folder
* `-if` is the path to the grayscale frames
* `-o` is the path to the output folder.

The script will plot ground-truth (in green) and predicted (in blue) poses on the input grayscale frames and will print 
the computed Mean Per Joint Position Error (MPJPE) metric in the terminal.